---
title: "Final Project Markdown"
author: "Carly Gottorff"
date: "November 27, 2018"
output: html_document
---

```{r}
library("RSQLite")
#Connect to data 
db <- dbConnect(SQLite(),"C:/Users/cgott/Documents/ST449/Datasets/database.sqlite")
## list all tables
tables <- dbListTables(db)
#Creating DF for each table
Country <- dbGetQuery(db,"Select * from Country")
League <- dbGetQuery(db,"Select * from League")
Match <- dbGetQuery(db,"Select * from Match")
Player <- dbGetQuery(db,"Select * from Player")
Player_Attributes <- dbGetQuery(db,"Select * from Player_Attributes")
Team <- dbGetQuery(db,"Select * from Team")
Team_Attributes <- dbGetQuery(db,"Select * from Team_Attributes")

```


```{r}
#Data Cleaning

#extracting data by English league 
leagueSplit<-dbGetQuery(db,"SELECT  league_id, season, home_team_api_id,
            away_team_api_id, home_team_goal, away_team_goal
           FROM Match 
           WHERE league_id='1729' ")

#B365H, B365A, B365D, BWH, BWA, BWD, IwA, IWH, IWD, LBH, LBA, LBD, PSH, PSD, PSA, WHA,WHH, WHD, SJA,SJD,SJH, VCA,VCH,VCD,GBA, GBH, GBD, BSH, BSA, BSD

#counting number of away matches for each team with long name
gamesPlayedAway<-dbGetQuery(db, "SELECT away_team_api_id, team_long_name, COUNT(away_team_api_id)
           FROM Match JOIN Team
            ON Match.away_team_api_id= Team.team_api_id
           WHERE league_id='1729'
           GROUP BY away_team_api_id")
#counting number of home matches for each team
gamesPlayedHome<-dbGetQuery(db, "SELECT home_team_api_id, COUNT(home_team_api_id)
           FROM Match 
           WHERE league_id='1729'
           GROUP BY home_team_api_id")

#merging away and home matches
colnames(gamesPlayedAway)<-c("team_api_id","team_long_name", "away_games")
colnames(gamesPlayedHome)= c("team_api_id", "home_games")
gamesPlayedAH<-merge(gamesPlayedAway, gamesPlayedHome, by="team_api_id")
#adding total games
gamesPlayedAH$totalPlayed<-(gamesPlayedAH$away_games+gamesPlayedAH$home_games)
```


```{r}
#extracting team attributes and matching to games
require(reshape)
#creating season variable for teams to merge with games accurately. Because the season runs from 09-05. calculations done in 09 are for that years season start year, while calculations done in 02 are done for the previous years season start year.
for (i in 1:length(Team_Attributes$date)){
  if(substr(Team_Attributes$date[i],6,7)=="09"){
    Team_Attributes$seasonStart[i]<-(substr(Team_Attributes$date[i],1,4))
  }
  if(substr(Team_Attributes$date[i],1,7)=="2016-02"){
    Team_Attributes$seasonStart[i]<-"2015"
  }
  if(substr(Team_Attributes$date[i],1,7)=="2015-02"){
    Team_Attributes$seasonStart[i]<-"2014"
  }
  if(substr(Team_Attributes$date[i],1,7)=="2014-02"){
    Team_Attributes$seasonStart[i]<-"2013"
  }
  if(substr(Team_Attributes$date[i],1,7)=="2013-02"){
    Team_Attributes$seasonStart[i]<-"2012"
  }
  if(substr(Team_Attributes$date[i],1,7)=="2012-02"){
    Team_Attributes$seasonStart[i]<-"2011"
  }
  if(substr(Team_Attributes$date[i],1,7)=="2011-02"){
    Team_Attributes$seasonStart[i]<-"2010"
  }
  if(substr(Team_Attributes$date[i],1,7)=="2010-02"){
    Team_Attributes$seasonStart[i]<-"2009"
  }
  if(substr(Team_Attributes$date[i],1,7)=="2009-02"){
    Team_Attributes$seasonStart[i]<-"2008"
  }
}

#seperating season to get the start year in order to merge with team attributes
leagueSplit<-transform(leagueSplit, season= colsplit(season, split="\\/", names=c("seasonStart", "SeasonStop")))

#creating identifier to merge game data to home team stats for that season

leagueSplit$p1<-paste0(leagueSplit$season$seasonStart, leagueSplit$home_team_api_id)
Team_Attributes$p1<-paste0(Team_Attributes$seasonStart, Team_Attributes$team_api_id)

#merging dfs and keeping all values to avoid ommitting any. !is.na is used to remove the values in merge that were caused by the p1 values from other leagues in Team_Attributes. By doing this we makes sure the exact same number of matches are being accounted for. This merge uses home team API. _Therefore the team stats bound to each game are for the home team. _
matchTeamAttHome <- merge(leagueSplit, Team_Attributes, by= "p1", all=TRUE)
matchTeamAttHome<-matchTeamAttHome[!is.na(matchTeamAttHome$league_id),]

#creating identifier to merge game data to away team stats for that season
leagueSplit$p2<-paste0(leagueSplit$season$seasonStart, leagueSplit$away_team_api_id)
Team_Attributes$p2<-paste0(Team_Attributes$seasonStart, Team_Attributes$team_api_id)
#merging match data and away team data using method specified above
matchTeamAttAway <- merge(leagueSplit, Team_Attributes, by= "p2", all=TRUE)
matchTeamAttAway<-matchTeamAttAway[!is.na(matchTeamAttAway$league_id),]

#380 team statistics are missing due to no stats on the team in that season for home team matches and 390 for away team matches. These are substancially smaller numbers than when not controlling for the month the stats were taken in, in those cases apporximately 700 values were missing. 
```


```{r}
#creating outcome varibale for win, lose, tie for home team
for (i in 1:nrow(leagueSplit)){
  if(leagueSplit$home_team_goal[i]==leagueSplit$away_team_goal[i]){
    leagueSplit$homeTie[i]=1
  } else{
    leagueSplit$homeTie[i]=0
  }
  if(leagueSplit$home_team_goal[i]>leagueSplit$away_team_goal[i]){
    leagueSplit$homeWin[i]=1
  }else{
    leagueSplit$homeWin[i]=0
  }
  if(leagueSplit$home_team_goal[i]<leagueSplit$away_team_goal[i]){
    leagueSplit$homeLose[i]=1
  }else{
    leagueSplit$homeLose[i]=0
  }
}
#creating win lose tie for away team
for (i in 1:nrow(leagueSplit)){
  if(leagueSplit$home_team_goal[i]==leagueSplit$away_team_goal[i]){
    leagueSplit$awayTie[i]=1
  } else{
    leagueSplit$awayTie[i]=0
  }
  if(leagueSplit$away_team_goal[i]>leagueSplit$home_team_goal[i]){
    leagueSplit$awayWin[i]=1
  }else{
    leagueSplit$awayWin[i]=0
  }
  if(leagueSplit$away_team_goal[i]<leagueSplit$home_team_goal[i]){
    leagueSplit$awayLose[i]=1
  }else{
    leagueSplit$awayLose[i]=0
  }
}

```


```{r}
library(dplyr)
#counting number of wins, loses, ties by team

#homeTie
homeTie<-leagueSplit %>%
  group_by(home_team_api_id, homeTie) %>%
  tally()
homeTie<-homeTie[homeTie$homeTie==1,] #removing cases of 0
homeTie<-homeTie[,c(1,3)]
colnames(homeTie)=c("team_api_id", "n_home_tie")

#home win
homeWin<-leagueSplit %>%
  group_by(home_team_api_id, homeWin) %>%
  tally()
homeWin<-homeWin[homeWin$homeWin==1,] #removing cases of 0
homeWin<-homeWin[,c(1,3)]
colnames(homeWin)=c("team_api_id", "n_home_win")

#home lose
homeLose<-leagueSplit %>%
  group_by(home_team_api_id, homeLose) %>%
  tally()
homeLose<-homeLose[homeLose$homeLose==1,] #removing cases of 0
homeLose<-homeLose[,c(1,3)]
colnames(homeLose)=c("team_api_id", "n_home_lose")

#awayTie
awayTie<-leagueSplit %>%
  group_by(home_team_api_id, awayTie) %>%
  tally()
awayTie<-awayTie[awayTie$awayTie==1,] #removing cases of 0
awayTie<-awayTie[,c(1,3)]
colnames(awayTie)=c("team_api_id", "n_away_tie")

#away win
awayWin<-leagueSplit %>%
  group_by(home_team_api_id, awayWin) %>%
  tally()
awayWin<-awayWin[awayWin$awayWin==1,] #removing cases of 0
awayWin<-awayWin[,c(1,3)]
colnames(awayWin)=c("team_api_id", "n_away_win")

#away lose
awayLose<-leagueSplit %>%
  group_by(home_team_api_id, awayLose) %>%
  tally()
awayLose<-awayLose[awayLose$awayLose==1,] #removing cases of 0
awayLose<-awayLose[,c(1,3)]
colnames(awayLose)=c("team_api_id", "n_away_lose")

#merging into gamesPlayedAH
gamesPlayedAH<-merge(gamesPlayedAH,homeTie, by="team_api_id")
gamesPlayedAH<-merge(gamesPlayedAH,homeWin, by="team_api_id")
gamesPlayedAH<-merge(gamesPlayedAH,homeLose, by="team_api_id")
gamesPlayedAH<-merge(gamesPlayedAH,awayTie, by="team_api_id")
gamesPlayedAH<-merge(gamesPlayedAH,awayWin, by="team_api_id")
gamesPlayedAH<-merge(gamesPlayedAH,awayLose, by="team_api_id")

#checking
gamesPlayedAH$tot<-(gamesPlayedAH$n_home_tie+gamesPlayedAH$n_home_win+gamesPlayedAH$n_home_lose+gamesPlayedAH$n_away_tie+gamesPlayedAH$n_away_lose+gamesPlayedAH$n_away_win)
gamesPlayedAH$correct<-(gamesPlayedAH$totalPlayed==gamesPlayedAH$tot)
```

```{r}
#creating total win lose tie variables
gamesPlayedAH$totWin<-(gamesPlayedAH$n_home_win+gamesPlayedAH$n_away_win)
gamesPlayedAH$totLose<-(gamesPlayedAH$n_home_lose+gamesPlayedAH$n_away_lose)
gamesPlayedAH$totTie<-(gamesPlayedAH$n_home_tie+gamesPlayedAH$n_away_tie)

#creating percent win tie for totals
gamesPlayedAH$percWin<-(gamesPlayedAH$totWin/gamesPlayedAH$totalPlayed)*100
gamesPlayedAH$percLose<-(gamesPlayedAH$totLose/gamesPlayedAH$totalPlayed)*100
gamesPlayedAH$percTie<-(gamesPlayedAH$totTie/gamesPlayedAH$totalPlayed)*100

#breakdownwin home or away by total wins 
gamesPlayedAH$percWinHome<-(gamesPlayedAH$n_home_win/gamesPlayedAH$totWin)*100
gamesPlayedAH$percWinAway<-(gamesPlayedAH$n_away_win/gamesPlayedAH$totWin)*100

#breakdown win home or away by total games
gamesPlayedAH$percWinHomeTot<-(gamesPlayedAH$n_home_win/gamesPlayedAH$totalPlayed)*100
gamesPlayedAH$percWinAwayTot<-(gamesPlayedAH$n_away_win/gamesPlayedAH$totalPlayed)*100

```


```{r}
#need to do: 
#create varible to negate season



```


```{r}
#exploritory statistics

#ordering data by the highest percent win
gamesPlayedAH[order(-gamesPlayedAH$percWin),]
#ordering data by highest percent win at home of all wins 
gamesPlayedAH[order(-gamesPlayedAH$percWinHome),]
#ordering by highest percent win away  of all wins 
gamesPlayedAH[order(-gamesPlayedAH$percWinAway),]
#ordering by highest percent win home by total games played
gamesPlayedAH[order(-gamesPlayedAH$percWinHomeTot),]
#odering by highest percent win away by total games played 
gamesPlayedAH[order(-gamesPlayedAH$percWinAwayTot),]

#frequency distribution of teams based on winning percentage
library(ggplot2)
plot_wins_freq <- 
  ggplot(gamesPlayedAH,aes(percWin))+geom_area(stat="bin",bins=10,fill="light blue")+xlab("Winning percentage")
plot_wins_freq

library(ggplot2)
plot_wins_home_freq <- 
  ggplot(gamesPlayedAH,aes(percWinHomeTot))+geom_area(stat="bin",bins=10,fill="light blue")+xlab("Winning percentage")
plot_wins_home_freq

```


```{r}
#splitting data into training. To 
set.seed(1234)
smp_size= floor(0.7* nrow(leagueSplit))
train_ind = sample(seq_len(nrow(leagueSplit)),size=smp_size)
train<- leagueSplit[train_ind,]
test<-leagueSplit[-train_ind,]



#option for negating time series
#clustering data by team and then splitting into training with previous seasons and test with latest season(2015/2016)
#seperating out by each season to compare later. 
#training is only previous 5 years 
test<-leagueSplit[leagueSplit$season=="2015/2016",]
train2014<-leagueSplit[leagueSplit$season=="2014/2015",]
train2013<-leagueSplit[leagueSplit$season=="2013/2014",]
train2012<-leagueSplit[leagueSplit$season=="2012/2013",]
train2011<-leagueSplit[leagueSplit$season=="2011/2012",]
train2010<-leagueSplit[leagueSplit$season=="2010/2011",]
train<-rbind(train2014, train2013, train2012, train2011, train2010)
table(train$home_team_api_id)

#creating function to extract team attributes associated with a given game

get_team_att<- function(team_api_id, year){
  for(i in 1:length(Team_Attributes)){
    if(Team_Attributes$team_api_id[i]==team_api_id){
      team<-Team_Attributes[i,]
    }
  }
}

for(i in 1:length(Team_Attributes)){
  if(Team_Attributes$team_api_id[i]=="9927"){
    t1<-Team_Attributes[i,]
  }
}
t1

#logistic regression with cross validation 
glm_fit<-glm()




```

```{r}

#logistic regression on training data
log_fit<-train()
```


